# ğŸ§ª í†µí•© í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ğŸ“‹ ê°œìš”

í†µí•© í…ŒìŠ¤íŠ¸ëŠ” **ì‹¤ì œ Supabase ë°ì´í„°ë² ì´ìŠ¤**ë¥¼ ì‚¬ìš©í•˜ì—¬ ì „ì²´ ì›Œí¬í”Œë¡œìš°ë¥¼ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.

## ğŸš€ ì‹¤í–‰ ë°©ë²•

### 1. í™˜ê²½ ë³€ìˆ˜ í™•ì¸

`.env.local` íŒŒì¼ì— ì‹¤ì œ Supabase ì—°ê²° ì •ë³´ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:

```bash
DATABASE_URL="postgresql://postgres.xxx:password@aws-1-ap-southeast-1.pooler.supabase.com:6543/postgres?schema=public"
NEXT_PUBLIC_SUPABASE_URL="https://xxx.supabase.co"
NEXT_PUBLIC_SUPABASE_ANON_KEY="your-anon-key"
```

### 2. í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰

```bash
# í†µí•© í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰
npm run test:integration

# ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (Mock ì‚¬ìš©)
npm run test:unit

# ëª¨ë“  í…ŒìŠ¤íŠ¸ ì‹¤í–‰
npm test
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### `policy-workflow.test.ts`

ì „ì²´ Policy ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸:

1. âœ… **Role 3ê°œ ìƒì„±** (Admin, Manager, Developer)
2. âœ… **Group 3ê°œ ìƒì„±** (Engineering, Design, QA)
3. âœ… **ì‚¬ìš©ì 3ëª… ìƒì„±** (í…ŒìŠ¤íŠ¸ìš© UUID)
4. âœ… **ì‚¬ìš©ìì—ê²Œ Role/Group í• ë‹¹**
   - User 1 â†’ Admin Role, Engineering Group
   - User 2 â†’ Manager Role, Design Group
   - User 3 â†’ Developer Role, QA Group
5. âœ… **Policy ìƒì„±** (ë¬¸ì„œ ê²°ì¬ ì •ì±…)
6. âœ… **State 5ê°œ ìƒì„±**
   - Create (ì´ˆê¸° ìƒíƒœ)
   - Assign
   - In Work
   - Review
   - Complete (ìµœì¢… ìƒíƒœ)
7. âœ… **ê° Stateë³„ Permission í• ë‹¹**
   - Create â†’ Admin Role (create)
   - Assign â†’ Manager Role (modify)
   - In Work â†’ Engineering Group (view)
   - Review â†’ Design Group (modify)
   - Complete â†’ Developer Role (view)
8. âœ… **Policy ìƒíƒœë³„ ê¶Œí•œ ì¡°íšŒ ë° ì¶œë ¥**

---

## ğŸ” ì˜ˆìƒ ì¶œë ¥

```
==============================================
ğŸ“‹ Policy Workflow í†µí•© í…ŒìŠ¤íŠ¸ ì‹œì‘
==============================================

1ï¸âƒ£ Role ìƒì„± ì¤‘...
   âœ… Admin ì—­í•  ìƒì„±: role-id-1
   âœ… Manager ì—­í•  ìƒì„±: role-id-2
   âœ… Developer ì—­í•  ìƒì„±: role-id-3
   ì´ 3ê°œ Role ìƒì„± ì™„ë£Œ

2ï¸âƒ£ Group ìƒì„± ì¤‘...
   âœ… Engineering ê·¸ë£¹ ìƒì„±: group-id-1
   âœ… Design ê·¸ë£¹ ìƒì„±: group-id-2
   âœ… QA ê·¸ë£¹ ìƒì„±: group-id-3
   ì´ 3ê°œ Group ìƒì„± ì™„ë£Œ

3ï¸âƒ£ ì‚¬ìš©ì ID ìƒì„± ì¤‘...
   âœ… User 1: test-user-1-...
   âœ… User 2: test-user-2-...
   âœ… User 3: test-user-3-...
   ì´ 3ëª… ì‚¬ìš©ì ìƒì„± ì™„ë£Œ

...

==============================================
ğŸ“Š Policy ìƒíƒœë³„ ê¶Œí•œ ë¦¬ìŠ¤íŠ¸
==============================================

Policy: Test_ë¬¸ì„œ_ê²°ì¬_ì •ì±…_...
Description: ë¬¸ì„œ ê²°ì¬ ì›Œí¬í”Œë¡œìš° í…ŒìŠ¤íŠ¸
Active: true

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
State 1: Create
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ì„¤ëª…: ë¬¸ì„œ ìƒì„±
  ìˆœì„œ: 1
  ì´ˆê¸° ìƒíƒœ: Yes
  ìµœì¢… ìƒíƒœ: No
  ê¶Œí•œ ê°œìˆ˜: 1

  ğŸ“œ ê¶Œí•œ ëª©ë¡:
     1. [CREATE] document
        ëŒ€ìƒ: Role: Test_Admin_...
        í—ˆìš©: âœ… Yes

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
State 2: Assign
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ì„¤ëª…: ë‹´ë‹¹ì í• ë‹¹
  ìˆœì„œ: 2
  ì´ˆê¸° ìƒíƒœ: No
  ìµœì¢… ìƒíƒœ: No
  ê¶Œí•œ ê°œìˆ˜: 1

  ğŸ“œ ê¶Œí•œ ëª©ë¡:
     1. [MODIFY] document
        ëŒ€ìƒ: Role: Test_Manager_...
        í—ˆìš©: âœ… Yes

...

==============================================
âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì™„ë£Œ!
==============================================
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì‚¬ìš©

- **Mockì´ ì•„ë‹Œ ì‹¤ì œ Supabase DBì— ì—°ê²°**í•©ë‹ˆë‹¤
- í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì‹¤ì œë¡œ ìƒì„±ë©ë‹ˆë‹¤
- í…ŒìŠ¤íŠ¸ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ ì •ë¦¬ë©ë‹ˆë‹¤ (`afterAll`)

### 2. í…ŒìŠ¤íŠ¸ ê²©ë¦¬

- ê° í…ŒìŠ¤íŠ¸ëŠ” ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤
- í…ŒìŠ¤íŠ¸ìš© ë°ì´í„°ëŠ” íƒ€ì„ìŠ¤íƒ¬í”„ë¡œ êµ¬ë¶„ë©ë‹ˆë‹¤
- ì‹¤íŒ¨ ì‹œì—ë„ ë°ì´í„° ì •ë¦¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤

### 3. ë„¤íŠ¸ì›Œí¬ ì—°ê²° í•„ìš”

- Supabase ì„œë²„ì™€ í†µì‹ í•©ë‹ˆë‹¤
- ë„¤íŠ¸ì›Œí¬ê°€ ëŠë¦¬ë©´ íƒ€ì„ì•„ì›ƒë  ìˆ˜ ìˆìŠµë‹ˆë‹¤
- íƒ€ì„ì•„ì›ƒ: 30ì´ˆ (ì„¤ì • ê°€ëŠ¥)

---

## ğŸ”§ ì»¤ìŠ¤í„°ë§ˆì´ì¦ˆ

### íƒ€ì„ì•„ì›ƒ ì¡°ì •

```javascript
// jest.integration.config.js
testTimeout: 60000, // 60ì´ˆë¡œ ì¦ê°€
```

### í…ŒìŠ¤íŠ¸ ë°ì´í„° ë³´ì¡´

```javascript
// afterAll ì£¼ì„ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„° ë³´ì¡´
afterAll(async () => {
  // await prisma.permission.deleteMany(...)
  // ì£¼ì„ ì²˜ë¦¬í•˜ë©´ ë°ì´í„°ê°€ ë‚¨ì•„ìˆìŒ
})
```

---

## ğŸ“Š ì°¨ì´ì : Unit vs Integration

| êµ¬ë¶„ | Unit Test | Integration Test |
|------|-----------|------------------|
| **DB ì—°ê²°** | âŒ Mock ì‚¬ìš© | âœ… ì‹¤ì œ DB |
| **ì†ë„** | âš¡ ë¹ ë¦„ (0.4ì´ˆ) | ğŸŒ ëŠë¦¼ (ìˆ˜ ì´ˆ) |
| **ê²©ë¦¬** | âœ… ì™„ì „ ê²©ë¦¬ | âš ï¸ DB ì˜ì¡´ |
| **ì‹¤í–‰** | `npm run test:unit` | `npm run test:integration` |
| **ëª©ì ** | ë¡œì§ ê²€ì¦ | ì „ì²´ í”Œë¡œìš° ê²€ì¦ |

---

## ğŸ¯ ì–¸ì œ ì‚¬ìš©í•˜ë‚˜?

### Unit Test ì‚¬ìš©

- API ë¡œì§ ê²€ì¦
- ì—ëŸ¬ ì²˜ë¦¬ ê²€ì¦
- ë¹ ë¥¸ í”¼ë“œë°± í•„ìš”
- CI/CD íŒŒì´í”„ë¼ì¸

### Integration Test ì‚¬ìš©

- ì‹¤ì œ DB ì—°ë™ í™•ì¸
- ì „ì²´ ì›Œí¬í”Œë¡œìš° ê²€ì¦
- ë°ì´í„° ë¬´ê²°ì„± í™•ì¸
- ë°°í¬ ì „ ìµœì¢… ê²€ì¦

---

## ğŸ› ë¬¸ì œ í•´ê²°

### "Can't reach database server"

**ì›ì¸**: `.env.local` íŒŒì¼ ëˆ„ë½ ë˜ëŠ” ì˜ëª»ëœ DB URL

**í•´ê²°**:
```bash
# .env.local íŒŒì¼ í™•ì¸
cat .env.local

# DATABASE_URL í™•ì¸
echo $DATABASE_URL
```

### íƒ€ì„ì•„ì›ƒ ì—ëŸ¬

**ì›ì¸**: ë„¤íŠ¸ì›Œí¬ ì§€ì—° ë˜ëŠ” ëŠë¦° DB

**í•´ê²°**:
```javascript
// jest.integration.config.js
testTimeout: 60000, // íƒ€ì„ì•„ì›ƒ ì¦ê°€
```

### ë°ì´í„° ì •ë¦¬ ì‹¤íŒ¨

**ì›ì¸**: Foreign Key ì œì•½ì¡°ê±´

**í•´ê²°**: `afterAll`ì—ì„œ ì—­ìˆœìœ¼ë¡œ ì‚­ì œ (ì´ë¯¸ êµ¬í˜„ë¨)

---

## ğŸ“š ê´€ë ¨ ë¬¸ì„œ

- **Unit Test ê°€ì´ë“œ**: `TEST_GUIDE.md`
- **API ë¬¸ì„œ**: `API_GUIDE.md`
- **Prisma Schema**: `prisma/schema.prisma`

---

**Happy Testing! ğŸš€**

